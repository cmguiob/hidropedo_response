---
title: "Procesamiento y análisis exploratorio de datos de suelos"
author: Carlos Guío
format: html
---

Este cuaderno utiliza un script externo para llamar los datos de SoilGrids a resolución de 1 x 1 km, y los exporta a formato .tif para luego analizarlos, de forma exploratoria, permitiendo la visualización de perfiles promedio por tipo de propiedad, así como la identificación de dominios espaciales. El análisis se realiza para todo Colombia.


```{r setup}

# Para cargar librerias se verifica pacman
if ("pacman" %in% installed.packages() == FALSE) install.packages("pacman")

# Se cargan las librerias
pacman::p_load(char = c(
  "here", #manejo de rutas
  "sf", #manipulación de dats espaciales
  "dplyr", #procesamiento de data frames
  "ggplot2",  #graficación
  "patchwork", #mosaicos gráficos
  "wesanderson", #paleta de colores
  "qs" #escribir y leer rápidamente objetos R
  )
)

#Paleta de colores
pal <- wes_palette("Zissou1", 100, type = "continuous")

# Ajusta tamaño de letra para las gráficas que genere el script
theme(base_size = 14)

```

### 1. Carga de datos

```{r carga}

# Crea un objeto tipo función al ejecutar un  script externo
source("00_funcion_descarga_soilgrids.R")

# Se llama la función con los argumentos adaptados al proyecto
stack_suelo_medias <- descargar_soilgrids_stack(
  vars = c("cfvo", "sand", "silt", "clay", "bdod", "soc"),
  depths = c("0-5cm", "5-15cm", "15-30cm", "60-100cm"),
  stats = c("mean"),
  resolucion = c(1000, 1000)
)


```

Se valida que los archivos se cargaron correctamente. Para esto, se calculan 

```{r}

# 1. Validación
names(stack_suelo_medias)  # Nombres de las capas

# 2. Medias por capa
print(global(stack_suelo_medias, fun = "mean", na.rm = TRUE))

# 3. NAs por capa
na_counts <- global(stack_suelo_medias, fun = function(x) sum(is.na(x)))
print(na_counts)

```


## 3. Pre-procesamiento

Se normalizan las escalas de las propiedades para poder usarlas posteriormente en modelos

```{r}

# 4. Normalización Z por capa
normaliza_var <- function(x) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
stack_suelo_z <- app(stack_suelo_medias, fun = normaliza_var)

# 5. Guardar el stack como .tif
out_raster <- here("Data", "soilgrids_stack.tif")
writeRaster(stack_suelo_z, filename = out_raster, overwrite = TRUE)

# 6. Volver a cargar desde archivo (opcional)
stack_suelo_z_tif <- rast(out_raster)


```


Se convierten los archivos .vrt en .tif para facilitar graficación y análisis.

```{r}


# 7. Graficar mosaico PNG
out_dir  <- here("Figures")
out_plot <- file.path(out_dir, "soilgrids.png")

# Dimensiones del PNG (ajustables)
n_layers <- nlyr(stack_suelo_z_tif)
png(out_plot, width = 3000, height = 3000, res = 300)

plot(
  stack_suelo_z_tif,
  main = names(stack_suelo_z_tif),  # Títulos por capa
  col = terrain.colors(20),
  mar = c(2, 2, 4, 6)
)

dev.off()
cat("Mosaico PNG guardado en:", out_plot, "\n")
```

